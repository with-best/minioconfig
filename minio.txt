#!/bin/bash
set -e  # 에러 발생 시 즉시 중단

# ==========================================
# 1. 변수 설정 (환경에 맞게 변경 필요)
# ==========================================
CURRENT_HOSTNAME="minio-vm-01" 
MINIO_VERSION="latest"
MINIO_USER="minio-user"
MINIO_PASS='1q2w3e4r!'

echo "=== 1. Hostname & Hosts 설정 ==="
hostnamectl set-hostname $CURRENT_HOSTNAME

if ! grep -q "minio-vm-01" /etc/hosts; then
cat <<EOF >> /etc/hosts
10.40.153.61 minio-vm-01.metanetx.com minio-vm-01
10.40.153.62 minio-vm-02.metanetx.com minio-vm-02
10.40.153.63 minio-vm-03.metanetx.com minio-vm-03
10.40.153.64 minio-vm-04.metanetx.com minio-vm-04
10.40.153.65 minio.metanetx.com       minio-lb
EOF
fi

echo "=== 2. File System & Mount ==="
mkfs.xfs -f -L MINIO_DATA01 /dev/sdb
mkfs.xfs -f -L MINIO_DATA02 /dev/sdc
mkfs.xfs -f -L MINIO_DATA03 /dev/sdd
mkfs.xfs -f -L MINIO_DATA04 /dev/sde

# 마운트 포인트 생성
mkdir -p /mnt/minio_data{01..04}

# fstab 등록 (중복 방지)
for i in {01..04}; do
  # 실제로는 디스크가 마운트 되어야 하므로 LABEL이나 UUID가 정확해야 합니다.
  # 테스트용으로 폴더만 만든 상태라면 이 부분은 실제 마운트 시에만 유효합니다.
  if ! grep -q "/mnt/minio_data${i}" /etc/fstab; then
      echo "LABEL=MINIO_DATA${i} /mnt/minio_data${i} xfs defaults,noatime 0 2" | tee -a /etc/fstab
  fi
done

mount -a  # 실제 디스크 라벨이 없으면 에러가 나므로 일단 주석 처리

echo "=== 3. MinIO 다운로드 및 사용자 생성 ==="
curl -L https://dl.min.io/server/minio/release/linux-amd64/minio -o /usr/local/bin/minio
chmod +x /usr/local/bin/minio


id -u $MINIO_USER &>/dev/null || useradd -r $MINIO_USER -s /sbin/nologin

for i in {01..04}; do
    chown -R $MINIO_USER:$MINIO_USER /mnt/minio_data${i}
done

echo "=== 4. TLS 인증서 생성 ==="
mkdir -p /etc/pki/minio
mkdir -p ~/minio-certs && cd ~/minio-certs

cat > openssl.conf <<EOF
[req]
distinguished_name = req_distinguished_name
x509_extensions = v3_req
prompt = no
[req_distinguished_name]
C = KR
ST = Seoul
L = Jongno
O = MetanetX
OU = HCU
CN = minio.metanetx.com
[v3_req]
basicConstraints = critical, CA:TRUE
keyUsage = critical, digitalSignature, keyEncipherment, keyCertSign
extendedKeyUsage = serverAuth
subjectAltName = @alt_names
[alt_names]
DNS.1 = minio.metanetx.com
DNS.2 = *.metanetx.com
DNS.3 = localhost
IP.1 = 10.40.153.65
IP.2 = 10.40.153.61
IP.3 = 10.40.153.62
IP.4 = 10.40.153.63
IP.5 = 10.40.153.64
IP.6 = 127.0.0.1
EOF

echo "Generating Key..."
# -nodes 옵션 중요 (암호 없이 키 생성해야 서비스 자동실행 가능)
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
  -keyout private.key -out public.crt -config openssl.conf

# 인증서 복사 및 **권한 설정 (매우 중요)**
cp public.crt /etc/pki/minio/public.crt
cp private.key /etc/pki/minio/private.key
# MinIO 유저가 읽을 수 있어야 함!
chown -R $MINIO_USER:$MINIO_USER /etc/pki/minio

echo "=== 5. MinIO 설정 파일 생성 ==="
# 수정됨: 점 3개(...) -> 점 2개(..)
# 수정됨: https 프로토콜과 포트 명시 권장
cat <<EOF > /etc/default/minio
MINIO_ROOT_USER=lokiadmin
MINIO_ROOT_PASSWORD='$MINIO_PASS'
MINIO_VOLUMES="https://minio-vm-{01..04}.metanetx.com:9000/mnt/minio_data{01..04}"
MINIO_OPTS="--address :9000 --console-address :9001 --certs-dir /etc/pki/minio"
EOF

echo "=== 6. Systemd 서비스 등록 ==="
cat <<EOF > /etc/systemd/system/minio.service
[Unit]
Description=MinIO Distributed Cluster
Documentation=https://docs.min.io
Wants=network-online.target
After=network-online.target
AssertFileIsExecutable=/usr/local/bin/minio

[Service]
WorkingDirectory=/usr/local/
User=$MINIO_USER
Group=$MINIO_USER
ProtectProc=invisible
EnvironmentFile=/etc/default/minio
ExecStart=/usr/local/bin/minio server \$MINIO_OPTS \$MINIO_VOLUMES
Restart=always
LimitNOFILE=65536
TasksMax=infinity
TimeoutStopSec=infinity
SendSIGKILL=no

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now minio

echo "Waiting for MinIO to start..."
sleep 5
systemctl status minio --no-pager

echo "=== 7. mc 클라이언트 설정 ==="
curl https://dl.min.io/client/mc/release/linux-amd64/mc --create-dirs -o /usr/local/bin/mc 
chmod +x /usr/local/bin/mc

# --insecure 추가 (사설 인증서(Self-signed) 사용 시 필수)
mc alias set myminio https://minio.metanetx.com:9000 lokiadmin '$MINIO_PASS' --insecure
mc admin info myminio --insecure

echo "Done."

