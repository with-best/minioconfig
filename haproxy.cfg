global
    log         127.0.0.1 local2
    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     4000
    user        haproxy
    group       haproxy
    daemon

defaults
    mode                    tcp
    log                     global
    option                  tcplog
    option                  dontlognull
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout check           10s
    maxconn                 3000

# ---------------------------------------------------------------------
# HAProxy 상태 모니터링 페이지 (Port 9002)
# http://<HAPROXY_IP>:9002/stats 로 접속 가능 (ID: admin / PW: password)
# ---------------------------------------------------------------------
listen stats
    bind *:9002
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:password

# ---------------------------------------------------------------------
# MinIO API Load Balancer (Port 9000) - 여기가 핵심입니다!
# ---------------------------------------------------------------------
frontend minio_api_front
    bind *:9000
    default_backend minio_api_back

    # HTTPS 상태 체크 (Health Check)
    # L4 모드이므로 단순 포트 체크(check)만 수행하거나, 
    # 정교하게 하려면 option ssl-hello-chk를 쓸 수 있습니다.
    # 여기서는 가장 확실한 '포트 접속 가능 여부'만 봅니다.
# backend 섹션 수정
backend minio_api_back
    balance roundrobin
    server minio01 minio-vm-01.metanetx.com:9000 check init-addr last,libc,none
    server minio02 minio-vm-02.metanetx.com:9000 check init-addr last,libc,none
    server minio03 minio-vm-03.metanetx.com:9000 check init-addr last,libc,none
    server minio04 minio-vm-04.metanetx.com:9000 check init-addr last,libc,none
# ---------------------------------------------------------------------
# MinIO Console Load Balancer (Port 9001) - 웹 관리자용
# ---------------------------------------------------------------------
frontend minio_console_front
    bind *:9001
    default_backend minio_console_back

backend minio_console_back
    balance roundrobin
    server minio01 minio-vm-01.metanetx.com:9001 check 
    server minio02 minio-vm-02.metanetx.com:9001 check 
    server minio03 minio-vm-03.metanetx.com:9001 check 
    server minio04 minio-vm-04.metanetx.com:9001 check
